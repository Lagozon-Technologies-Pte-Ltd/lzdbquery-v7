logger.info(f"AI query description: {description}")
        logger.info(f"AI-generated SQL: {sql_statement}")

        if database == "GCP":
            # Proactively log client and credentials info for debugging
            logger.info("BigQuery client info: %s, credentials: %s", db, getattr(db, "_credentials", None))
            logger.info("About to execute BigQuery SQL: %s", sql_statement)
            # BigQuery Python client is synchronous; run in thread if heavy (for async).
            rows = db.query(sql_statement).result()
            logger.info("BigQuery ran and returned rows.")
            result_json = [dict(row) for row in rows]
            logger.info(f"BigQuery Results (sample): {result_json[:3]}")
            df = pd.DataFrame(result_json)
            return {
                "description": description,
                "sql": sql_statement,
                "table": df.to_dict(orient="records"),
            }
        else:
            logger.warning("Selected database not GCP; skipping execution.")
            return {"error": "Unsupported database"}

    except Exception as e:
        logger.error("Error in submit_query: %s\n%s", e, traceback.format_exc())
        return {"error": "Query execution failed", "details": str(e)}

    except BaseException as e:
        logger.critical("Fatal error: %s", e)
        return {"error": "Unexpected fatal error", "details": str(e)}





GOOGLE_CREDENTIALS_CLIENT_EMAIL = "mdp-ad-gld-dev-talkto-dta-view@mdp-ad-gld-dta-dev-133464.iam.gserviceaccount.com"
GOOGLE_CREDENTIALS_CLIENT_ID = "114267503023593270821"
GOOGLE_CREDENTIALS_PRIVATE_KEY_ID = "7154fbcccc0e1dc495fa475dc991964df27cebbb"
GOOGLE_CREDENTIALS_PROJECT_ID = "mdp-ad-gld-dta-dev-133464"
GOOGLE_CREDENTIALS_TYPE = "service_account"
GOOGLE_CREDENTIALS_CLIENT_X509_CERT_URL = https://www.googleapis.com/robot/v1/metadata/x509/mdp-ad-gld-dev-talkto-dta-view%40mdp-ad-gld-dta-dev-133464.iam.gserviceaccount.com,

- Question
  --Get all distinct details related to Model Family Desc and Dealer details about this RO RO25D000730
  --SQL QUERY: 
	SELECT DISTINCT `MM`.`FAMLY_DESC` AS `MODEL_FAMILY_DESC`, `AD`.`DELR_NAME` AS `DEALER_NAME`, `AD`.`LOCTN_NAME` AS `DEALER_LOCATI
	ON` 
	FROM `MH_RO_HDR_DETAILS` AS `ROHDR` 
	INNER JOIN `srv_mst_dim_model_master` AS `MM` 
	ON `ROHDR`.`MODL_CD` = `MM`.`MODL_CD` 
	INNER JOIN `ddp_ad_ai_final_dimension` AS `AD` 
	ON `ROHDR`.`LOCTN_CD` = `AD`.`LOCTN_CD` AND `ROHDR`.`PARNT_GROP` = `AD`.`PARNT_GROP` AND `ROHDR`.`PRODCT_DIVSN` = `AD`.`PRODCT_DIVSN` 
	WHERE `ROHDR`.`RO_ID` = 'RO25D000730' LIMIT 1000;
	
- Question 
  --List all dealers in a North zone along with their Locations
  --SQL QUERY:
    SELECT `AD`.`DELR_NAME` AS `DEALER_NAME`, `AD`.`LOCTN_NAME` AS `LOCATI
	ON_NAME` 
	FROM `ddp_ad_ai_final_dimension` AS `AD` 
	WHERE LOWER(`AD`.`Z
	ONE_NAME`) = 'north zone' LIMIT 1000;
 
- Question
  --Show the number of ROs per dealer for the month of Jan'25
  --SQL QUERY:
 	SELECT `AD`.`DELR_NAME` AS `DEALER_NAME`, COUNT(`ROHDR`.`RO_ID`) AS `REPAIR_ORDER_COUNT` 
	FROM `MH_RO_HDR_DETAILS` AS `ROHDR` 
	INNER JOIN `ddp_ad_ai_final_dimension` AS `AD` 
	ON `ROHDR`.`LOCTN_CD` = `AD`.`LOCTN_CD` AND `ROHDR`.`PARNT_GROP` = `AD`.`PARNT_GROP` AND `ROHDR`.`PRODCT_DIVSN` = 	   `AD`.`PRODCT_DIVSN` 
	WHERE `ROHDR`.`RO_DATE` BETWEEN DATE '2025-01-01' AND DATE '2025-01-31' 
	GROUP BY `AD`.`DELR_NAME` 
 
 
- Question
  --List all models and their associated variants and fuel types.
  --SQL QUERY:
    SELECT `AD`.`DELR_NAME` AS `DEALER_NAME`, COUNT(`ROHDR`.`RO_ID`) AS `REPAIR_ORDER_COUNT` 
	FROM `MH_RO_HDR_DETAILS` AS `ROHDR` 
	INNER JOIN `ddp_ad_ai_final_dimension` AS `AD` 
	ON `ROHDR`.`LOCTN_CD` = `AD`.`LOCTN_CD` AND `ROHDR`.`PARNT_GROP` = `AD`.`PARNT_GROP` AND `ROHDR`.`PRODCT_DIVSN` = `AD`.`PRODCT_DIVSN` 
	WHERE `ROHDR`.`RO_DATE` BETWEEN DATE '2025-01-01' AND DATE '2025-01-31' 
	GROUP BY `AD`.`DELR_NAME` 
	ORDER BY `REPAIR_ORDER_COUNT` DESC LIMIT 1;
 
- Question
  -- Show the BATCH codes where both ELECTRIC and DIESEL fuel types exist. For each such BATCH, return the total number of    model entries and count of each FUEL_TYPE.
  -- SQL QUERY:
	SELECT `MM`.`BATCH` AS `BATCH_CODE`, COUNT(*) AS `TOTAL_MODEL_COUNT`, SUM(CASE WHEN LOWER(`MM`.`FUEL_TYPE`) = 'electric' THEN 1 ELSE 0 END) AS `ELECTRIC_FUEL_TYPE_COUNT`, SUM(CASE WHEN LOWER(`MM`.`FUEL_TYPE`) = 'diesel' THEN 1 ELSE 0 END) AS `DIESEL_FUEL_TYPE_COUNT` 
	FROM `srv_mst_dim_model_master` AS `MM` 
	GROUP BY `MM`.`BATCH` 
	HAVING SUM(CASE WHEN LOWER(`MM`.`FUEL_TYPE`) = 'electric' THEN 1 ELSE 0 END) > 0 AND SUM(CASE WHEN LOWER(`MM`.`FUEL_TYPE`) = 'diesel' THEN 1 ELSE 0 END) > 0 
	ORDER BY `MM`.`BATCH` LIMIT 1000;
 
- Question
  
 
 
	ORDER BY `REPAIR_ORDER_COUNT` DESC LIMIT 1000;


"-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCb4SAdl5MMn2LH\n5LUJkdIKYZOtFtZCbgZB+5KvLHrm6T1tdnCAkFIhYZhlRVHcJQcQMJ9oh1KnTrKI\notk02B3DQCTtr2eJ0E3fh+8f44Kd5dSFfjmnD0YFEn3nNyLvxOuepTHyYHsGDxEe\nGQaL1AnlsbDgYt/hACSKYaX4d2s6QUb9U82WY/a92h/M5MlFIJZETSkE2LIHHQah\ntiMN8vpIhj+vOAmg5MukFrRr3NRv3xYhDjivxv7bggVaZ0l3eoAriszsZkvMmPtt\nTLq4gSj4ZkoMs5yjkctDqyskv9VT65DA4D4NV4gs8r5lqorH3+K2J817BKhW7aMm\nx1nVjnenAgMBAAECggEAQ5b1Nv+fWmzOB0DrIvAgtDGlN/tcAkf03K156A0QaYmf\nAhTGKWjqw+CulNLe8Ob5ThLXPBrZQwSDs21xY1GGbkAlAw74hTBWY+NsU1ZyL4cV\nhKC73O1pfg+LmjM1KeQoCo00wBUHoxPrZzKQvRa/B+LpgBI/Yy+NqJc4wSj+zK4N\n/v74ylZDtFQadM2AXTGY/rWLE4gUwjUxuadEPRipAph6LVQVXnk55YJg+M2mEarJ\nzo6PzdG70ydkbm9vEmlRMLArnLSTzzLi3tI4putQSeKCMf5yAz5MIAmxkBuVHP8H\nTpU7NhQ/tR51vtB++gdJLVtjKrRvCyqeAJmakikPSQKBgQDPZZxuoM8u5HzuH0lt\nB6a7nXwOKemg2AV/yw5IKuUZIJE8er3FYvpPKERRQf+UrEPO8tXeo4WI51ZHZVbt\nk0WnOPBVUUbngwKxFe2YYbaVZzYlYiyaDtdzwHqUocm7VU9SG5p8ppuMqg9gSRuK\nUMMCmSNcK+UEf2hFzfnYtbGCCwKBgQDAaNE8n9hPN6RImNw4rTO/LB9iI+u9hIND\nI7mhUXBKHTJBcqKehZ6qcHyFbAS8PkwWXkvTRj+ywSTIM6O1pXwCvStqE3WCnNtu\ndbP7lRYz2RaYBuNCT663odbIrHsobieY8XaRAPobu2g88Geivj45SNuJ1sMWQ875\nH4wLssMeVQKBgQDFWkCoePeN/Ljw8u6xBJXhdDOnWrTJbKaW+4eEnuTQq0/pCDdr\nDAt6pauU00O8mswPsr5XFK2uH8zXNZSpj/m47ZKs7SGWjfFSx7YGyfyvYL6ChlBA\n7RySNjevFeFcFQrc7A1uzi+4g98L1aWSUdWvtD+UpuRQClkUC7PTRto6DwKBgQCH\nwWzf+WgFfJzNHA1Fb+8y007RT8bk0LpMhMhUqcEwiakLxHY4os5wMy2oda5hoxLM\nNXwKdWY8GUp6dvTrFPeKdy5KibA/l6y7IxD6URZ5PpJScYmnH9GGfwmsTQYYYKBP\nqQ6fALF3H6NMW9LDYLdGc8FyX7UF4JIH89o75sUEgQKBgFkJcEbeHqFLrTQzpnXN\niZFaa+hkXFf/asBSx2boG8HTcPrexodk52CqewkA904lIMwk8jgIfuoHDrEyoziq\nLKjyQ/qR/U5CP10VNAC5ocrGVKDcG+lIt+LkfwywnB3kddn4Q5j6psjy73oVY9GI\nO08uuzQLim/KEH99o14ENg6M\n-----END PRIVATE KEY-----\n"





[
  {
    "name": "adv_db_database",
    "value": "adventureworks",
    "slotSetting": false
  },
  {
    "name": "adv_db_schema",
    "value": "production",
    "slotSetting": false
  },
  {
    "name": "adv_db_schema_hr",
    "value": "humanresources",
    "slotSetting": false
  },
  {
    "name": "adv_db_schema_pe",
    "value": "person",
    "slotSetting": false
  },
  {
    "name": "adv_db_schema_purchase",
    "value": "purchasing",
    "slotSetting": false
  },
  {
    "name": "adv_db_schema_sales",
    "value": "sales",
    "slotSetting": false
  },
  {
    "name": "AZURE_CONTAINER_NAME",
    "value": "mazdmdpcnt01",
    "slotSetting": false
  },
  {
    "name": "AZURE_DEPLOYMENT_NAME",
    "value": "gpt-4.1-mini",
    "slotSetting": false
  },
  {
    "name": "AZURE_EMBEDDING_DEPLOYMENT_NAME",
    "value": "text-embedding-3-small",
    "slotSetting": false
  },
  {
    "name": "AZURE_OPENAI_API_KEY",
    "value": "",
    "slotSetting": false
  },
  {
    "name": "AZURE_OPENAI_API_VERSION",
    "value": "2024-12-01-preview",
    "slotSetting": false
  },
  {
    "name": "AZURE_OPENAI_ENDPOINT",
    "value": "https://southindia.api.cognitive.microsoft.com/",
    "slotSetting": false
  },
  {
    "name": "AZURE_STORAGE_CONNECTION_STRING",
    "value": 
	"DefaultEndpointsProtocol=https;AccountName=mazdmdpsa01;AccountKey=6gB9vXqEKGnYw2DvhyyBQ81RphjoPPQz5i/r2k3zYwin61aAz7aJ9b0QVypaP7XGK0nLNK5rTXVo
+ASte1HJOW==; EndpointSuffix=core.windows.net",
    "slotSetting": false
  },
  {
    "name": "Chroma_Query_Examples",
    "value": "/home/chroma_db/Chroma_Query_Examples",
    "slotSetting": false
  },
  {
    "name": "Chroma_Schema_Metadata",
    "value": "/home/chroma_db/Chroma_Schema_Metadata",
    "slotSetting": false
  },
  {
    "name": "dataset_id",
    "value": "prateekproject-450509.MH_RO_DATA",
    "slotSetting": false
  },
  {
    "name": "db_database",
    "value": "postgres",
    "slotSetting": false
  },
  {
    "name": "db_host",
    "value": "postgresql1.postgres.database.azure.com",
    "slotSetting": false
  },
  {
    "name": "db_password",
    "value": "do_not_use",
    "slotSetting": false
  },
  {
    "name": "db_port",
    "value": "5432",
    "slotSetting": false
  },
  {
    "name": "db_tables",
    "value": "[\"ddp_ad_ai_final_dimension\",\"mh_model_master\",\"mh_ro_hdr_details\",\"mh_ro_parts\",\"mh_ro_labour\", \"verbatim_cmm_aruna\"]",
    "slotSetting": false
  },
  {
    "name": "db_user",
    "value": "admin",
    "slotSetting": false
  },
  {
    "name": "fetch_semantic_schema",
    "value": "True",
    "slotSetting": false
  },
  {
    "name": "GOOGLE_CREDENTIALS_CLIENT_EMAIL",
    "value": "bqserviceacc@prateekproject-450509.iam.gserviceaccount.com",
    "slotSetting": false
  },
  {
    "name": "GOOGLE_CREDENTIALS_CLIENT_ID",
    "value": "113170843501102392568",
    "slotSetting": false
  },
  {
    "name": "GOOGLE_CREDENTIALS_PRIVATE_KEY_ID",
    "value": "ed95d3833a3389da07659457b8c0f89d57a1aff4",
    "slotSetting": false
  },
  {
    "name": "GOOGLE_CREDENTIALS_PROJECT_ID",
    "value": "prateekproject-450509",
    "slotSetting": false
  },
  {
    "name": "GOOGLE_CREDENTIALS_TYPE",
    "value": "service_account",
    "slotSetting": false
  },
  {
    "name": "key_parameters",
    "value": "Dealer Zone,Year,Month,Product,VIN,Customer Feedback,Repair Order Number,Feedback Category,Service Date",
    "slotSetting": false
  },
  {
    "name": "OPENAI_API_TYPE",
    "value": "azure",
    "slotSetting": false
  },
  {
    "name": "Question_dropdown",
    "value": "Choose from frequently asked Questions or Enter your own Questions",
    "slotSetting": false
  },
  {
    "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
    "value": "1",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_DRIVER",
    "value": "ODBC Driver 18 for SQL Server",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_NAME",
    "value": "mazdmdpdb1",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_PASSWORD",
    "value": "",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_PORT",
    "value": "1433",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_SERVER",
    "value": "http://mazdmdpsrvrl.database.windows.net",
    "slotSetting": false
  },
  {
    "name": "SQL_DB_USER",
    "value": "mdpuser1",
    "slotSetting": false
  },
  {
    "name": "SQL_MAX_OVERFLOW",
    "value": "10",
    "slotSetting": false
  },
  {
    "name": "SQL_POOL_SIZE",
    "value": "50",
    "slotSetting": false
  },
  {
    "name": "subject_areas1",
    "value": "Demo, Finance,Customer Support",
    "slotSetting": false
  },
  {
    "name": "System_Maintenance",
    "value": "N",
    "slotSetting": false
  },
  {
    "name": "WEBSITE_HTTPLOGGING_RETENTION_DAYS",
    "value": "7",
    "slotSetting": false
  }
]
